{% extends "base.html" %}

{% block title %}Кладовщик - AWR{% endblock %}

{% block page_title %}
<i class="bi bi-archive me-2"></i>Панель кладовщика
{% endblock %}

{% block sidebar_menu %}
<li class="nav-item">
    <a class="nav-link active" href="{{ url_for('dashboard') }}">
        <i class="bi bi-speedometer2"></i>Главная
    </a>
</li>
<li class="nav-item">
    <a class="nav-link" href="#" onclick="showSection('add-materials')">
        <i class="bi bi-plus-circle"></i>Пополнить ТМЦ
    </a>
</li>
<li class="nav-item">
    <a class="nav-link" href="#" onclick="showSection('edit-materials')">
        <i class="bi bi-pencil-square"></i>Редактировать ТМЦ
    </a>
</li>
<li class="nav-item">
    <a class="nav-link" href="#" onclick="showSection('add-tools')">
        <i class="bi bi-plus-circle"></i>Пополнить инструмент
    </a>
</li>
<li class="nav-item">
    <a class="nav-link" href="#" onclick="showSection('edit-tools')">
        <i class="bi bi-pencil-square"></i>Редактировать инструмент
    </a>
</li>
<li class="nav-item">
    <a class="nav-link" href="#" onclick="showSection('manage-materials')">
        <i class="bi bi-box-seam"></i>ТМЦ
    </a>
</li>
<li class="nav-item">
    <a class="nav-link" href="#" onclick="showSection('manage-tools')">
        <i class="bi bi-tools"></i>Инструмент
    </a>
</li>
<li class="nav-item">
    <a class="nav-link" href="#" onclick="showSection('brigade-materials')">
        <i class="bi bi-people"></i>ТМЦ бригад
    </a>
</li>
<li class="nav-item">
    <a class="nav-link" href="#" onclick="showSection('brigade-tools')">
        <i class="bi bi-gear"></i>Инструмент бригад
    </a>
</li>
<li class="nav-item">
    <a class="nav-link" href="#" onclick="showSection('stock-balance')">
        <i class="bi bi-clipboard-data"></i>Остатки
    </a>
</li>
<li class="nav-item">
    <a class="nav-link" href="#" onclick="showSection('warehouse-log')">
        <i class="bi bi-journal-text"></i>Ведёт учёт
    </a>
</li>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Статистические карточки -->
    <div class="row mb-4">
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card-modern">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="text-muted mb-1">Видов материалов</h6>
                            <h3 class="mb-0 text-primary" id="materialsTypes">-</h3>
                        </div>
                        <div class="rounded-circle bg-primary bg-gradient p-3">
                            <i class="bi bi-box-seam text-white fs-4"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card-modern">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="text-muted mb-1">Единиц инструмента</h6>
                            <h3 class="mb-0 text-warning" id="toolsCount">-</h3>
                        </div>
                        <div class="rounded-circle bg-warning bg-gradient p-3">
                            <i class="bi bi-tools text-white fs-4"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card-modern">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="text-muted mb-1">У бригад</h6>
                            <h3 class="mb-0 text-success" id="brigadesItems">-</h3>
                        </div>
                        <div class="rounded-circle bg-success bg-gradient p-3">
                            <i class="bi bi-people text-white fs-4"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card-modern">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="text-muted mb-1">Операций сегодня</h6>
                            <h3 class="mb-0 text-info" id="todayOperations">-</h3>
                        </div>
                        <div class="rounded-circle bg-info bg-gradient p-3">
                            <i class="bi bi-arrow-repeat text-white fs-4"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Быстрые действия -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card-modern">
                <div class="card-header bg-gradient-primary text-white">
                    <h5 class="mb-0">
                        <i class="bi bi-lightning-charge me-2"></i>Быстрые действия
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-lg-2 col-md-4 col-sm-6 mb-3">
                            <button class="btn btn-primary-modern w-100" onclick="showAddMaterials()">
                                <i class="bi bi-plus-circle me-2"></i>
                                Добавить ТМЦ
                            </button>
                        </div>
                        <div class="col-lg-2 col-md-4 col-sm-6 mb-3">
                            <button class="btn btn-outline-warning w-100" onclick="showAddTools()">
                                <i class="bi bi-tools me-2"></i>
                                Добавить инструмент
                            </button>
                        </div>
                        <div class="col-lg-2 col-md-4 col-sm-6 mb-3">
                            <button class="btn btn-outline-success w-100" onclick="showIssueToBrigade()">
                                <i class="bi bi-arrow-right-circle me-2"></i>
                                Выдать бригаде
                            </button>
                        </div>
                        <div class="col-lg-2 col-md-4 col-sm-6 mb-3">
                            <button class="btn btn-outline-info w-100" onclick="showReturnFromBrigade()">
                                <i class="bi bi-arrow-left-circle me-2"></i>
                                Вернуть на склад
                            </button>
                        </div>
                        <div class="col-lg-2 col-md-4 col-sm-6 mb-3">
                            <button class="btn btn-outline-secondary w-100" onclick="showStockBalance()">
                                <i class="bi bi-clipboard-data me-2"></i>
                                Остатки
                            </button>
                        </div>
                        <div class="col-lg-2 col-md-4 col-sm-6 mb-3">
                            <button class="btn btn-outline-dark w-100" onclick="exportReport()">
                                <i class="bi bi-download me-2"></i>
                                Экспорт
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Главные секции -->
    <div class="row mb-4">
        <!-- Остатки на складе -->
        <div class="col-lg-6">
            <div class="card-modern">
                <div class="card-header bg-gradient-success text-white">
                    <h5 class="mb-0">
                        <i class="bi bi-archive me-2"></i>Остатки на складе
                    </h5>
                </div>
                <div class="card-body">
                    <ul class="nav nav-tabs" id="stockTabs" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="materials-tab" data-bs-toggle="tab" data-bs-target="#materials" type="button" role="tab">
                                <i class="bi bi-box me-2"></i>Материалы
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="tools-tab" data-bs-toggle="tab" data-bs-target="#tools" type="button" role="tab">
                                <i class="bi bi-tools me-2"></i>Инструменты
                            </button>
                        </li>
                    </ul>
                    <div class="tab-content" id="stockTabsContent">
                        <div class="tab-pane fade show active" id="materials" role="tabpanel">
                            <div id="materialsStock" class="mt-3">
                                <!-- Список материалов -->
                            </div>
                        </div>
                        <div class="tab-pane fade" id="tools" role="tabpanel">
                            <div id="toolsStock" class="mt-3">
                                <!-- Список инструментов -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Последние операции -->
        <div class="col-lg-6">
            <div class="card-modern">
                <div class="card-header bg-gradient-dark text-white">
                    <h5 class="mb-0">
                        <i class="bi bi-clock-history me-2"></i>Последние операции
                    </h5>
                </div>
                <div class="card-body">
                    <div id="recentOperations">
                        <!-- Последние операции -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Бригады и их материалы -->
    <div class="row">
        <div class="col-12">
            <div class="card-modern">
                <div class="card-header bg-gradient-info text-white">
                    <h5 class="mb-0">
                        <i class="bi bi-people me-2"></i>Материалы и инструменты у бригад
                    </h5>
                </div>
                <div class="card-body">
                    <div id="brigadesStockInfo">
                        <!-- Информация о материалах у бригад -->
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Модальное окно для добавления материалов -->
<div class="modal fade" id="addMaterialsModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Пополнить ТМЦ</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="addMaterialsForm">
                    <div class="mb-3">
                        <label class="form-label">Материал</label>
                        <select class="form-select" id="materialSelect" required>
                            <option value="">Выберите материал</option>
                            <option value="Кабель ВОК 4 100">Кабель ВОК 4 100 (м)</option>
                            <option value="БО/16 100">БО/16 100 (шт)</option>
                            <option value="Шпаклёвка 100">Шпаклёвка 100 (кг)</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Количество</label>
                        <input type="number" class="form-control" id="materialQuantity" min="1" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Комментарий</label>
                        <textarea class="form-control" id="materialComment" rows="2"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                <button type="button" class="btn btn-primary" onclick="addMaterials()">Добавить</button>
            </div>
        </div>
    </div>
</div>

<!-- Модальное окно для выдачи бригаде -->
<div class="modal fade" id="issueToBrigadeModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Выдать бригаде</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="issueToBrigadeForm">
                    <div class="mb-3">
                        <label class="form-label">Бригада</label>
                        <select class="form-select" id="brigadeSelect" required>
                            <option value="">Выберите бригаду</option>
                            <option value="Бригада 1">Бригада 1</option>
                            <option value="Бригада 2">Бригада 2</option>
                            <option value="Бригада 3">Бригада 3</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Тип</label>
                        <select class="form-select" id="itemType" onchange="updateItemOptions()" required>
                            <option value="">Выберите тип</option>
                            <option value="material">Материал</option>
                            <option value="tool">Инструмент</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Предмет</label>
                        <select class="form-select" id="itemSelect" required>
                            <option value="">Сначала выберите тип</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Количество</label>
                        <input type="number" class="form-control" id="issueQuantity" min="1" required>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                <button type="button" class="btn btn-primary" onclick="issueToBrigade()">Выдать</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Загрузка данных при загрузке страницы
document.addEventListener('DOMContentLoaded', function() {
    loadWarehouseDashboard();
    loadMaterialsStock();
    loadToolsStock();
    loadRecentOperations();
    loadBrigadesStockInfo();
});

function loadWarehouseDashboard() {
    // Симуляция загрузки статистики склада
    const stats = {
        materialsTypes: 3,
        toolsCount: 8,
        brigadesItems: 15,
        todayOperations: 7
    };
    
    document.getElementById('materialsTypes').textContent = stats.materialsTypes;
    document.getElementById('toolsCount').textContent = stats.toolsCount;
    document.getElementById('brigadesItems').textContent = stats.brigadesItems;
    document.getElementById('todayOperations').textContent = stats.todayOperations;
}

function loadMaterialsStock() {
    const materials = [
        { name: 'Кабель ВОК 4 100', quantity: 1000, unit: 'м', status: 'good' },
        { name: 'БО/16 100', quantity: 500, unit: 'шт', status: 'good' },
        { name: 'Шпаклёвка 100', quantity: 50, unit: 'кг', status: 'low' }
    ];
    
    let html = '<div class="table-responsive"><table class="table table-hover"><thead><tr><th>Материал</th><th>Количество</th><th>Статус</th><th>Действия</th></tr></thead><tbody>';
    
    materials.forEach(material => {
        const statusBadge = material.status === 'good' ? 
            '<span class="badge bg-success">В наличии</span>' : 
            '<span class="badge bg-warning">Мало</span>';
        
        html += `
            <tr>
                <td>${material.name}</td>
                <td>${material.quantity} ${material.unit}</td>
                <td>${statusBadge}</td>
                <td>
                    <button class="btn btn-sm btn-outline-primary" onclick="editMaterial('${material.name}')">
                        <i class="bi bi-pencil"></i>
                    </button>
                </td>
            </tr>
        `;
    });
    
    html += '</tbody></table></div>';
    document.getElementById('materialsStock').innerHTML = html;
}

function loadToolsStock() {
    const tools = [
        { name: 'Перфоратор проводной', serial: 'SN001', status: 'available' },
        { name: 'Перфоратор беспроводной', serial: 'SN002', status: 'issued' },
        { name: 'Аккумулятор 6 ампер', serial: 'SN003', status: 'available' },
        { name: 'Аккумулятор 6 ампер', serial: 'SN004', status: 'available' },
        { name: 'Аккумулятор 6 ампер', serial: 'SN005', status: 'issued' }
    ];
    
    let html = '<div class="table-responsive"><table class="table table-hover"><thead><tr><th>Инструмент</th><th>S/N</th><th>Статус</th><th>Действия</th></tr></thead><tbody>';
    
    tools.forEach(tool => {
        const statusBadge = tool.status === 'available' ? 
            '<span class="badge bg-success">Доступен</span>' : 
            '<span class="badge bg-warning">Выдан</span>';
        
        html += `
            <tr>
                <td>${tool.name}</td>
                <td>${tool.serial}</td>
                <td>${statusBadge}</td>
                <td>
                    <button class="btn btn-sm btn-outline-primary" onclick="editTool('${tool.serial}')">
                        <i class="bi bi-pencil"></i>
                    </button>
                </td>
            </tr>
        `;
    });
    
    html += '</tbody></table></div>';
    document.getElementById('toolsStock').innerHTML = html;
}

function loadRecentOperations() {
    const operations = [
        { time: '14:30', type: 'Выдача', item: 'Кабель ВОК 4 100', quantity: '50 м', brigade: 'Бригада 1' },
        { time: '13:15', type: 'Возврат', item: 'Аккумулятор 6 ампер', quantity: '1 шт', brigade: 'Бригада 2' },
        { time: '11:00', type: 'Пополнение', item: 'Шпаклёвка 100', quantity: '100 кг', brigade: '-' },
        { time: '09:45', type: 'Выдача', item: 'БО/16 100', quantity: '20 шт', brigade: 'Бригада 3' }
    ];
    
    let html = '';
    operations.forEach(op => {
        const typeClass = op.type === 'Выдача' ? 'warning' : op.type === 'Возврат' ? 'info' : 'success';
        const icon = op.type === 'Выдача' ? 'arrow-right' : op.type === 'Возврат' ? 'arrow-left' : 'plus';
        
        html += `
            <div class="d-flex align-items-center mb-3 p-2 border rounded">
                <div class="rounded-circle bg-${typeClass} bg-gradient me-3 p-2">
                    <i class="bi bi-${icon} text-white"></i>
                </div>
                <div class="flex-grow-1">
                    <div class="fw-bold">${op.item}</div>
                    <small class="text-muted">${op.quantity} • ${op.brigade} • ${op.time}</small>
                </div>
                <span class="badge bg-${typeClass}">${op.type}</span>
            </div>
        `;
    });
    
    document.getElementById('recentOperations').innerHTML = html;
}

function loadBrigadesStockInfo() {
    const brigades = [
        { 
            name: 'Бригада 1', 
            materials: [
                { name: 'Кабель ВОК 4 100', quantity: '150 м' },
                { name: 'БО/16 100', quantity: '25 шт' }
            ],
            tools: [
                { name: 'Перфоратор беспроводной', serial: 'SN002' }
            ]
        },
        { 
            name: 'Бригада 2', 
            materials: [
                { name: 'Шпаклёвка 100', quantity: '15 кг' }
            ],
            tools: []
        },
        { 
            name: 'Бригада 3', 
            materials: [
                { name: 'Кабель ВОК 4 100', quantity: '200 м' },
                { name: 'БО/16 100', quantity: '30 шт' }
            ],
            tools: [
                { name: 'Аккумулятор 6 ампер', serial: 'SN005' }
            ]
        }
    ];
    
    let html = '<div class="row">';
    
    brigades.forEach((brigade, index) => {
        html += `
            <div class="col-md-4 mb-3">
                <div class="card h-100">
                    <div class="card-header bg-light">
                        <h6 class="card-title mb-0">${brigade.name}</h6>
                    </div>
                    <div class="card-body">
                        <h6 class="text-muted">Материалы:</h6>
        `;
        
        if (brigade.materials.length === 0) {
            html += '<p class="text-muted small">Нет материалов</p>';
        } else {
            brigade.materials.forEach(material => {
                html += `<div class="small mb-1">• ${material.name}: ${material.quantity}</div>`;
            });
        }
        
        html += '<h6 class="text-muted mt-3">Инструменты:</h6>';
        
        if (brigade.tools.length === 0) {
            html += '<p class="text-muted small">Нет инструментов</p>';
        } else {
            brigade.tools.forEach(tool => {
                html += `<div class="small mb-1">• ${tool.name} (${tool.serial})</div>`;
            });
        }
        
        html += `
                    </div>
                    <div class="card-footer">
                        <button class="btn btn-sm btn-outline-primary" onclick="manageBrigadeStock('${brigade.name}')">
                            Управление
                        </button>
                    </div>
                </div>
            </div>
        `;
    });
    
    html += '</div>';
    document.getElementById('brigadesStockInfo').innerHTML = html;
}

// Функции для модальных окон
function showAddMaterials() {
    const modal = new bootstrap.Modal(document.getElementById('addMaterialsModal'));
    modal.show();
}

function showAddTools() {
    alert('Функция добавления инструментов будет реализована');
}

function showIssueToBrigade() {
    const modal = new bootstrap.Modal(document.getElementById('issueToBrigadeModal'));
    modal.show();
}

function showReturnFromBrigade() {
    alert('Функция возврата от бригады будет реализована');
}

function showStockBalance() {
    alert('Функция просмотра остатков будет реализована');
}

function exportReport() {
    alert('Экспорт отчета в Excel будет реализован');
}

function addMaterials() {
    const material = document.getElementById('materialSelect').value;
    const quantity = document.getElementById('materialQuantity').value;
    const comment = document.getElementById('materialComment').value;
    
    if (!material || !quantity) {
        alert('Пожалуйста, заполните все обязательные поля');
        return;
    }
    
    // Здесь будет реализован API вызов
    alert(`Добавлено: ${material} - ${quantity} единиц`);
    
    // Закрыть модальное окно
    const modal = bootstrap.Modal.getInstance(document.getElementById('addMaterialsModal'));
    modal.hide();
    
    // Обновить данные
    loadMaterialsStock();
    loadWarehouseDashboard();
}

function updateItemOptions() {
    const itemType = document.getElementById('itemType').value;
    const itemSelect = document.getElementById('itemSelect');
    
    itemSelect.innerHTML = '<option value="">Выберите предмет</option>';
    
    if (itemType === 'material') {
        const materials = ['Кабель ВОК 4 100', 'БО/16 100', 'Шпаклёвка 100'];
        materials.forEach(material => {
            itemSelect.innerHTML += `<option value="${material}">${material}</option>`;
        });
    } else if (itemType === 'tool') {
        const tools = ['Перфоратор проводной SN001', 'Аккумулятор 6 ампер SN003', 'Аккумулятор 6 ампер SN004'];
        tools.forEach(tool => {
            itemSelect.innerHTML += `<option value="${tool}">${tool}</option>`;
        });
    }
}

function issueToBrigade() {
    const brigade = document.getElementById('brigadeSelect').value;
    const itemType = document.getElementById('itemType').value;
    const item = document.getElementById('itemSelect').value;
    const quantity = document.getElementById('issueQuantity').value;
    
    if (!brigade || !itemType || !item || !quantity) {
        alert('Пожалуйста, заполните все поля');
        return;
    }
    
    // Здесь будет реализован API вызов
    alert(`Выдано ${brigade}: ${item} - ${quantity} единиц`);
    
    // Закрыть модальное окно
    const modal = bootstrap.Modal.getInstance(document.getElementById('issueToBrigadeModal'));
    modal.hide();
    
    // Обновить данные
    loadBrigadesStockInfo();
    loadRecentOperations();
}

function editMaterial(materialName) {
    alert(`Редактирование материала: ${materialName}`);
}

function editTool(serial) {
    alert(`Редактирование инструмента: ${serial}`);
}

function manageBrigadeStock(brigadeName) {
    alert(`Управление материалами: ${brigadeName}`);
}

// Обновление данных каждые 30 секунд
setInterval(() => {
    loadWarehouseDashboard();
    loadRecentOperations();
}, 30000);
</script>
{% endblock %}