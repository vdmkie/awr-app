{% extends "base.html" %}

{% block title %}Список задач - AWR{% endblock %}

{% block page_title %}
<i class="bi bi-list-check me-2"></i>Список задач
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Фильтры -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card-modern">
                <div class="card-header bg-gradient-info text-white">
                    <h6 class="mb-0">
                        <i class="bi bi-funnel me-2"></i>Фильтры
                    </h6>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-3">
                            <label class="form-label">Статус</label>
                            <select class="form-select" id="statusFilter" onchange="applyFilters()">
                                <option value="">Все статусы</option>
                                <option value="Новая задача">Новая задача</option>
                                <option value="В работе">В работе</option>
                                <option value="Выполнено">Выполнено</option>
                                <option value="Отложено">Отложено</option>
                                <option value="Проблемный дом">Проблемный дом</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Бригада</label>
                            <select class="form-select" id="brigadeFilter" onchange="applyFilters()">
                                <option value="">Все бригады</option>
                                <option value="Бригада 1">Бригада 1</option>
                                <option value="Бригада 2">Бригада 2</option>
                                <option value="Бригада 3">Бригада 3</option>
                                <option value="Бригада 4">Бригада 4</option>
                                <option value="Бригада 5">Бригада 5</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Вид работ</label>
                            <select class="form-select" id="workTypeFilter" onchange="applyFilters()">
                                <option value="">Все виды работ</option>
                                <option value="воздушка">воздушка</option>
                                <option value="перемычка">перемычка</option>
                                <option value="растянуть дом">растянуть дом</option>
                                <option value="дом под ключ">дом под ключ</option>
                                <option value="бурение">бурение</option>
                                <option value="сварки">сварки</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Поиск по адресу</label>
                            <input type="text" class="form-control" id="addressSearch" 
                                   placeholder="Введите адрес" onkeyup="applyFilters()">
                        </div>
                    </div>
                    <div class="row mt-3">
                        <div class="col-md-6">
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="urgentOnlyFilter" onchange="applyFilters()">
                                <label class="form-check-label text-danger fw-bold" for="urgentOnlyFilter">
                                    <i class="bi bi-exclamation-triangle me-2"></i>Только срочные
                                </label>
                            </div>
                        </div>
                        <div class="col-md-6 text-end">
                            <button class="btn btn-outline-secondary btn-sm" onclick="clearFilters()">
                                <i class="bi bi-x-circle me-2"></i>Очистить фильтры
                            </button>
                            <span class="badge bg-primary ms-2" id="taskCount">0 задач</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Кнопки действий -->
    {% if user.role in ['super_admin', 'admin'] %}
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <button class="btn btn-primary-modern" onclick="location.href='{{ url_for('new_task') }}'">
                        <i class="bi bi-plus-circle me-2"></i>Создать задачу
                    </button>
                    <button class="btn btn-outline-success ms-2" onclick="exportTasks()">
                        <i class="bi bi-download me-2"></i>Экспорт
                    </button>
                </div>
                <div>
                    <div class="btn-group" role="group">
                        <input type="radio" class="btn-check" name="viewMode" id="cardView" checked onchange="toggleView('card')">
                        <label class="btn btn-outline-primary" for="cardView">
                            <i class="bi bi-grid-3x3-gap"></i>
                        </label>
                        
                        <input type="radio" class="btn-check" name="viewMode" id="tableView" onchange="toggleView('table')">
                        <label class="btn btn-outline-primary" for="tableView">
                            <i class="bi bi-list"></i>
                        </label>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Список задач - карточки -->
    <div id="cardViewContainer">
        <div class="row" id="tasksContainer">
            <!-- Задачи будут загружены динамически -->
        </div>
    </div>

    <!-- Список задач - таблица -->
    <div id="tableViewContainer" style="display: none;">
        <div class="card-modern">
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover" id="tasksTable">
                        <thead>
                            <tr>
                                <th onclick="sortTable(0)">ID <i class="bi bi-arrow-down-up"></i></th>
                                <th onclick="sortTable(1)">Адрес <i class="bi bi-arrow-down-up"></i></th>
                                <th onclick="sortTable(2)">Вид работ <i class="bi bi-arrow-down-up"></i></th>
                                <th onclick="sortTable(3)">Статус <i class="bi bi-arrow-down-up"></i></th>
                                <th onclick="sortTable(4)">Бригада <i class="bi bi-arrow-down-up"></i></th>
                                <th onclick="sortTable(5)">Дата создания <i class="bi bi-arrow-down-up"></i></th>
                                <th>Действия</th>
                            </tr>
                        </thead>
                        <tbody id="tasksTableBody">
                            <!-- Строки таблицы будут загружены динамически -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Пагинация -->
    <div class="row mt-4">
        <div class="col-12">
            <nav aria-label="Навигация по страницам">
                <ul class="pagination justify-content-center" id="pagination">
                    <!-- Пагинация будет создана динамически -->
                </ul>
            </nav>
        </div>
    </div>
</div>

<!-- Модальное окно для деталей задачи -->
<div class="modal fade" id="taskDetailModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Детали задачи</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="taskDetailContent">
                <!-- Детали задачи будут загружены динамически -->
            </div>
            <div class="modal-footer" id="taskDetailActions">
                <!-- Действия будут добавлены динамически в зависимости от роли -->
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let allTasks = [];
let filteredTasks = [];
let currentPage = 1;
const tasksPerPage = 12;

// Загрузка задач при загрузке страницы
document.addEventListener('DOMContentLoaded', function() {
    loadTasks();
    
    // Применить фильтры из URL параметров
    const urlParams = new URLSearchParams(window.location.search);
    if (urlParams.get('urgent')) {
        document.getElementById('urgentOnlyFilter').checked = true;
    }
    if (urlParams.get('status')) {
        document.getElementById('statusFilter').value = urlParams.get('status');
    }
    
    applyFilters();
});

function loadTasks() {
    fetch('/api/tasks')
        .then(response => response.json())
        .then(tasks => {
            allTasks = tasks;
            applyFilters();
        })
        .catch(error => {
            console.error('Ошибка загрузки задач:', error);
            document.getElementById('tasksContainer').innerHTML = 
                '<div class="col-12 text-center"><p class="text-muted">Ошибка загрузки данных</p></div>';
        });
}

function applyFilters() {
    const statusFilter = document.getElementById('statusFilter').value;
    const brigadeFilter = document.getElementById('brigadeFilter').value;
    const workTypeFilter = document.getElementById('workTypeFilter').value;
    const addressSearch = document.getElementById('addressSearch').value.toLowerCase();
    const urgentOnly = document.getElementById('urgentOnlyFilter').checked;
    
    filteredTasks = allTasks.filter(task => {
        const matchesStatus = !statusFilter || task.status === statusFilter;
        const matchesBrigade = !brigadeFilter || task.assigned_brigade === brigadeFilter;
        const matchesWorkType = !workTypeFilter || task.work_type === workTypeFilter;
        const matchesAddress = !addressSearch || task.address.toLowerCase().includes(addressSearch);
        const matchesUrgent = !urgentOnly || task.urgent;
        
        return matchesStatus && matchesBrigade && matchesWorkType && matchesAddress && matchesUrgent;
    });
    
    currentPage = 1;
    displayTasks();
    updatePagination();
    updateTaskCount();
}

function displayTasks() {
    const startIndex = (currentPage - 1) * tasksPerPage;
    const endIndex = startIndex + tasksPerPage;
    const tasksToShow = filteredTasks.slice(startIndex, endIndex);
    
    if (document.getElementById('cardView').checked) {
        displayTasksAsCards(tasksToShow);
    } else {
        displayTasksAsTable(tasksToShow);
    }
}

function displayTasksAsCards(tasks) {
    const container = document.getElementById('tasksContainer');
    
    if (tasks.length === 0) {
        container.innerHTML = `
            <div class="col-12 text-center p-5">
                <i class="bi bi-search display-1 text-muted"></i>
                <h4 class="mt-3 text-muted">Задачи не найдены</h4>
                <p class="text-muted">Попробуйте изменить параметры фильтра</p>
            </div>
        `;
        return;
    }
    
    let html = '';
    
    tasks.forEach(task => {
        const statusClass = getStatusClass(task.status);
        const urgentBadge = task.urgent ? '<span class="urgent-badge ms-2">СРОЧНО!</span>' : '';
        const createdDate = task.created_date ? new Date(task.created_date).toLocaleDateString() : '-';
        const assignedDate = task.assigned_date ? new Date(task.assigned_date).toLocaleDateString() : '-';
        const completedDate = task.completed_date ? new Date(task.completed_date).toLocaleDateString() : '-';
        
        html += `
            <div class="col-lg-4 col-md-6 mb-4">
                <div class="card task-card h-100" onclick="showTaskDetail(${task.id})">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-start mb-3">
                            <h6 class="card-title mb-0">
                                #${task.id} • ${task.address}${urgentBadge}
                            </h6>
                            <span class="status-badge ${statusClass}" data-status="${task.status}">${task.status}</span>
                        </div>
                        
                        <div class="mb-3">
                            <div class="d-flex justify-content-between mb-1">
                                <span class="text-muted small">Вид работ:</span>
                                <span class="small fw-bold">${task.work_type}</span>
                            </div>
                            <div class="d-flex justify-content-between mb-1">
                                <span class="text-muted small">Этажи/Парадные:</span>
                                <span class="small">${task.floors}/${task.entrances}</span>
                            </div>
                            <div class="d-flex justify-content-between mb-1">
                                <span class="text-muted small">Бригада:</span>
                                <span class="small">${task.assigned_brigade || '-'}</span>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <div class="text-muted small mb-1">Даты:</div>
                            <div class="small">
                                <i class="bi bi-calendar-plus me-1"></i>Создано: ${createdDate}<br>
                                ${task.assigned_date ? `<i class="bi bi-play-circle me-1"></i>В работе: ${assignedDate}<br>` : ''}
                                ${task.completed_date ? `<i class="bi bi-check-circle me-1"></i>Завершено: ${completedDate}` : ''}
                            </div>
                        </div>
                        
                        <div class="text-truncate text-muted small">
                            ${task.description || 'Нет описания'}
                        </div>
                    </div>
                    <div class="card-footer bg-light">
                        <div class="d-flex justify-content-between align-items-center">
                            <small class="text-muted">
                                <i class="bi bi-person me-1"></i>${task.created_by || 'Система'}
                            </small>
                            <div>
                                ${getTaskActions(task)}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `;
    });
    
    container.innerHTML = html;
}

function displayTasksAsTable(tasks) {
    const tbody = document.getElementById('tasksTableBody');
    
    if (tasks.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="7" class="text-center p-5">
                    <i class="bi bi-search display-1 text-muted"></i>
                    <div class="mt-3 text-muted">Задачи не найдены</div>
                </td>
            </tr>
        `;
        return;
    }
    
    let html = '';
    
    tasks.forEach(task => {
        const statusClass = getStatusClass(task.status);
        const urgentBadge = task.urgent ? '<span class="urgent-badge ms-1">!</span>' : '';
        const createdDate = task.created_date ? new Date(task.created_date).toLocaleDateString() : '-';
        
        html += `
            <tr onclick="showTaskDetail(${task.id})" style="cursor: pointer;">
                <td>#${task.id}</td>
                <td>${task.address}${urgentBadge}</td>
                <td>${task.work_type}</td>
                <td><span class="status-badge ${statusClass}" data-status="${task.status}">${task.status}</span></td>
                <td>${task.assigned_brigade || '-'}</td>
                <td>${createdDate}</td>
                <td>
                    ${getTaskActions(task)}
                </td>
            </tr>
        `;
    });
    
    tbody.innerHTML = html;
}

function getTaskActions(task) {
    const userRole = '{{ user.role }}';
    const userName = '{{ user.name }}';
    let actions = '';
    
    if (userRole === 'super_admin' || userRole === 'admin') {
        actions += `<button class="btn btn-sm btn-outline-primary me-1" onclick="event.stopPropagation(); editTask(${task.id})"><i class="bi bi-pencil"></i></button>`;
    }
    
    if (userRole === 'brigade' && task.assigned_brigade === userName && task.status === 'В работе') {
        actions += `<button class="btn btn-sm btn-outline-success" onclick="event.stopPropagation(); location.href='/task/${task.id}/report'"><i class="bi bi-file-earmark-text"></i></button>`;
    }
    
    return actions;
}

function getStatusClass(status) {
    switch(status) {
        case 'Новая задача': return 'status-new';
        case 'В работе': return 'status-progress';
        case 'Выполнено': return 'status-completed';
        case 'Отложено': return 'status-postponed';
        case 'Проблемный дом': return 'status-problem';
        default: return 'status-new';
    }
}

function showTaskDetail(taskId) {
    const task = allTasks.find(t => t.id === taskId);
    if (!task) return;
    
    const modal = new bootstrap.Modal(document.getElementById('taskDetailModal'));
    const content = document.getElementById('taskDetailContent');
    const actions = document.getElementById('taskDetailActions');
    
    const urgentBadge = task.urgent ? '<span class="urgent-badge ms-2">СРОЧНО!</span>' : '';
    const createdDate = task.created_date ? new Date(task.created_date).toLocaleDateString() : '-';
    const assignedDate = task.assigned_date ? new Date(task.assigned_date).toLocaleDateString() : '-';
    const completedDate = task.completed_date ? new Date(task.completed_date).toLocaleDateString() : '-';
    
    content.innerHTML = `
        <div class="row">
            <div class="col-md-6">
                <h6 class="text-primary">Основная информация</h6>
                <table class="table table-sm">
                    <tr><td><strong>ID:</strong></td><td>#${task.id}</td></tr>
                    <tr><td><strong>Адрес:</strong></td><td>${task.address}${urgentBadge}</td></tr>
                    <tr><td><strong>Этажи:</strong></td><td>${task.floors}</td></tr>
                    <tr><td><strong>Парадные:</strong></td><td>${task.entrances}</td></tr>
                    <tr><td><strong>Вид работ:</strong></td><td>${task.work_type}</td></tr>
                    <tr><td><strong>Статус:</strong></td><td><span class="status-badge ${getStatusClass(task.status)}">${task.status}</span></td></tr>
                </table>
            </div>
            <div class="col-md-6">
                <h6 class="text-primary">Назначение и даты</h6>
                <table class="table table-sm">
                    <tr><td><strong>Создатель:</strong></td><td>${task.created_by || '-'}</td></tr>
                    <tr><td><strong>Бригада:</strong></td><td>${task.assigned_brigade || '-'}</td></tr>
                    <tr><td><strong>Администратор:</strong></td><td>${task.assigned_admin || '-'}</td></tr>
                    <tr><td><strong>Создано:</strong></td><td>${createdDate}</td></tr>
                    <tr><td><strong>В работе с:</strong></td><td>${assignedDate}</td></tr>
                    <tr><td><strong>Завершено:</strong></td><td>${completedDate}</td></tr>
                </table>
            </div>
        </div>
        <div class="row mt-3">
            <div class="col-12">
                <h6 class="text-primary">Техническое задание</h6>
                <div class="border rounded p-3 bg-light">
                    ${task.description || 'Нет описания'}
                </div>
            </div>
        </div>
        <div class="row mt-3">
            <div class="col-12">
                <h6 class="text-primary">Информация о доступе</h6>
                <div class="border rounded p-3 bg-light">
                    ${task.access_info || 'Нет информации'}
                </div>
            </div>
        </div>
    `;
    
    // Формирование кнопок действий в зависимости от роли
    const userRole = '{{ user.role }}';
    let actionsHtml = '<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Закрыть</button>';
    
    if (userRole === 'super_admin' || userRole === 'admin') {
        actionsHtml += `<button type="button" class="btn btn-primary ms-2" onclick="editTask(${task.id})">Редактировать</button>`;
    }
    
    if (userRole === 'brigade' && task.assigned_brigade === '{{ user.name }}' && task.status === 'В работе') {
        actionsHtml += `<button type="button" class="btn btn-success ms-2" onclick="location.href='/task/${task.id}/report'">Создать отчет</button>`;
    }
    
    actions.innerHTML = actionsHtml;
    modal.show();
}

function toggleView(viewType) {
    if (viewType === 'card') {
        document.getElementById('cardViewContainer').style.display = 'block';
        document.getElementById('tableViewContainer').style.display = 'none';
    } else {
        document.getElementById('cardViewContainer').style.display = 'none';
        document.getElementById('tableViewContainer').style.display = 'block';
    }
    
    displayTasks();
}

function clearFilters() {
    document.getElementById('statusFilter').value = '';
    document.getElementById('brigadeFilter').value = '';
    document.getElementById('workTypeFilter').value = '';
    document.getElementById('addressSearch').value = '';
    document.getElementById('urgentOnlyFilter').checked = false;
    applyFilters();
}

function updateTaskCount() {
    const count = filteredTasks.length;
    const countText = count === 1 ? '1 задача' : 
                     count < 5 ? `${count} задачи` : 
                     `${count} задач`;
    document.getElementById('taskCount').textContent = countText;
}

function updatePagination() {
    const totalPages = Math.ceil(filteredTasks.length / tasksPerPage);
    const pagination = document.getElementById('pagination');
    
    if (totalPages <= 1) {
        pagination.innerHTML = '';
        return;
    }
    
    let html = '';
    
    // Предыдущая страница
    html += `
        <li class="page-item ${currentPage === 1 ? 'disabled' : ''}">
            <a class="page-link" href="#" onclick="changePage(${currentPage - 1})">Предыдущая</a>
        </li>
    `;
    
    // Номера страниц
    for (let i = 1; i <= totalPages; i++) {
        if (i === 1 || i === totalPages || (i >= currentPage - 2 && i <= currentPage + 2)) {
            html += `
                <li class="page-item ${i === currentPage ? 'active' : ''}">
                    <a class="page-link" href="#" onclick="changePage(${i})">${i}</a>
                </li>
            `;
        } else if (i === currentPage - 3 || i === currentPage + 3) {
            html += '<li class="page-item disabled"><span class="page-link">...</span></li>';
        }
    }
    
    // Следующая страница
    html += `
        <li class="page-item ${currentPage === totalPages ? 'disabled' : ''}">
            <a class="page-link" href="#" onclick="changePage(${currentPage + 1})">Следующая</a>
        </li>
    `;
    
    pagination.innerHTML = html;
}

function changePage(page) {
    const totalPages = Math.ceil(filteredTasks.length / tasksPerPage);
    if (page < 1 || page > totalPages) return;
    
    currentPage = page;
    displayTasks();
    updatePagination();
    
    // Прокрутка к началу списка
    document.querySelector('.container-fluid').scrollIntoView({ behavior: 'smooth' });
}

function editTask(taskId) {
    // Переход к редактированию задачи
    location.href = `/task/${taskId}/edit`;
}

function exportTasks() {
    // Экспорт задач
    alert('Функция экспорта будет реализована');
}

function sortTable(columnIndex) {
    // Сортировка таблицы
    alert('Функция сортировки будет реализована');
}

// Обновление данных каждые 30 секунд
setInterval(loadTasks, 30000);
</script>
{% endblock %}