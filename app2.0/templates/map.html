{% extends "base.html" %}

{% block title %}Карта объектов - AWR{% endblock %}

{% block page_title %}
<i class="bi bi-geo-alt me-2"></i>Карта объектов
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Панель управления картой -->
    <div class="row mb-3">
        <div class="col-12">
            <div class="card-modern">
                <div class="card-body py-2">
                    <div class="row align-items-center">
                        <div class="col-md-6">
                            <div class="d-flex align-items-center">
                                <label class="form-label me-3 mb-0">Фильтры:</label>
                                <select class="form-select form-select-sm me-2" id="mapStatusFilter" onchange="updateMapMarkers()" style="width: auto;">
                                    <option value="">Все статусы</option>
                                    <option value="Новая задача">Новая задача</option>
                                    <option value="В работе">В работе</option>
                                    <option value="Выполнено">Выполнено</option>
                                    <option value="Отложено">Отложено</option>
                                    <option value="Проблемный дом">Проблемный дом</option>
                                </select>
                                {% if user.role in ['super_admin', 'admin'] %}
                                <select class="form-select form-select-sm me-2" id="mapBrigadeFilter" onchange="updateMapMarkers()" style="width: auto;">
                                    <option value="">Все бригады</option>
                                    <option value="Бригада 1">Бригада 1</option>
                                    <option value="Бригада 2">Бригада 2</option>
                                    <option value="Бригада 3">Бригада 3</option>
                                    <option value="Бригада 4">Бригада 4</option>
                                    <option value="Бригада 5">Бригада 5</option>
                                </select>
                                {% endif %}
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="urgentOnlyMap" onchange="updateMapMarkers()">
                                    <label class="form-check-label text-danger small" for="urgentOnlyMap">
                                        Только срочные
                                    </label>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6 text-end">
                            <button class="btn btn-outline-primary btn-sm" onclick="centerMap()">
                                <i class="bi bi-geo me-1"></i>Центрировать
                            </button>
                            <button class="btn btn-outline-success btn-sm" onclick="toggleFullscreen()">
                                <i class="bi bi-fullscreen me-1"></i>Полный экран
                            </button>
                            <span class="badge bg-info ms-2" id="mapTaskCount">0 объектов</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Карта -->
    <div class="row">
        <div class="col-lg-9">
            <div class="card-modern">
                <div class="card-body p-0">
                    <div id="map" style="height: 70vh; border-radius: 15px;"></div>
                </div>
            </div>
        </div>
        
        <!-- Боковая панель с информацией -->
        <div class="col-lg-3">
            <div class="card-modern">
                <div class="card-header bg-gradient-info text-white">
                    <h6 class="mb-0">
                        <i class="bi bi-info-circle me-2"></i>Информация о задачах
                    </h6>
                </div>
                <div class="card-body">
                    <div id="mapTaskInfo">
                        <div class="text-center text-muted">
                            <i class="bi bi-cursor-fill display-4"></i>
                            <p class="mt-2">Выберите объект на карте для просмотра информации</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Легенда -->
            <div class="card-modern mt-3">
                <div class="card-header bg-gradient-secondary text-white">
                    <h6 class="mb-0">
                        <i class="bi bi-palette me-2"></i>Легенда
                    </h6>
                </div>
                <div class="card-body">
                    <div class="legend-item d-flex align-items-center mb-2">
                        <div class="legend-marker bg-info rounded-circle me-2" style="width: 12px; height: 12px;"></div>
                        <small>Новая задача</small>
                    </div>
                    <div class="legend-item d-flex align-items-center mb-2">
                        <div class="legend-marker bg-warning rounded-circle me-2" style="width: 12px; height: 12px;"></div>
                        <small>В работе</small>
                    </div>
                    <div class="legend-item d-flex align-items-center mb-2">
                        <div class="legend-marker bg-success rounded-circle me-2" style="width: 12px; height: 12px;"></div>
                        <small>Выполнено</small>
                    </div>
                    <div class="legend-item d-flex align-items-center mb-2">
                        <div class="legend-marker bg-secondary rounded-circle me-2" style="width: 12px; height: 12px;"></div>
                        <small>Отложено</small>
                    </div>
                    <div class="legend-item d-flex align-items-center mb-2">
                        <div class="legend-marker bg-danger rounded-circle me-2" style="width: 12px; height: 12px;"></div>
                        <small>Проблемный дом</small>
                    </div>
                    <hr>
                    <div class="legend-item d-flex align-items-center">
                        <div class="legend-marker border border-danger border-2 rounded-circle me-2" style="width: 12px; height: 12px; background: rgba(220, 53, 69, 0.3);"></div>
                        <small class="text-danger fw-bold">Срочная задача</small>
                    </div>
                </div>
            </div>

            <!-- Статистика -->
            <div class="card-modern mt-3">
                <div class="card-header bg-gradient-dark text-white">
                    <h6 class="mb-0">
                        <i class="bi bi-bar-chart me-2"></i>Статистика
                    </h6>
                </div>
                <div class="card-body">
                    <div id="mapStatistics">
                        <!-- Статистика будет загружена динамически -->
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Модальное окно с детальной информацией о задаче -->
<div class="modal fade" id="mapTaskModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Информация о задаче</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="mapTaskModalContent">
                <!-- Содержимое будет загружено динамически -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Закрыть</button>
                <button type="button" class="btn btn-primary" id="viewTaskDetailsBtn" onclick="viewFullTaskDetails()">
                    Подробнее
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let map;
let markers = [];
let allTasks = {{ tasks | tojsonfilter | safe }};
let selectedTaskId = null;

// Инициализация карты
document.addEventListener('DOMContentLoaded', function() {
    initMap();
    loadMapTasks();
    updateMapStatistics();
});

function initMap() {
    // Инициализация карты с центром в Москве
    map = L.map('map').setView([55.7558, 37.6176], 10);
    
    // Добавление слоя карты OpenStreetMap
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '© OpenStreetMap contributors'
    }).addTo(map);
    
    // Настройка стилей карты
    map.getContainer().style.borderRadius = '15px';
}

function loadMapTasks() {
    fetch('/api/tasks')
        .then(response => response.json())
        .then(tasks => {
            allTasks = tasks;
            updateMapMarkers();
        })
        .catch(error => {
            console.error('Ошибка загрузки задач:', error);
        });
}

function updateMapMarkers() {
    // Очистка существующих маркеров
    markers.forEach(marker => map.removeLayer(marker));
    markers = [];
    
    // Получение фильтров
    const statusFilter = document.getElementById('mapStatusFilter').value;
    const brigadeFilter = document.getElementById('mapBrigadeFilter') ? 
                         document.getElementById('mapBrigadeFilter').value : '';
    const urgentOnly = document.getElementById('urgentOnlyMap').checked;
    const userRole = '{{ user.role }}';
    const userName = '{{ user.name }}';
    
    // Фильтрация задач
    let filteredTasks = allTasks.filter(task => {
        const matchesStatus = !statusFilter || task.status === statusFilter;
        const matchesBrigade = !brigadeFilter || task.assigned_brigade === brigadeFilter;
        const matchesUrgent = !urgentOnly || task.urgent;
        
        // Для бригад показываем только их задачи в работе
        if (userRole === 'brigade') {
            return task.assigned_brigade === userName && 
                   task.status === 'В работе' && 
                   matchesStatus && matchesUrgent;
        }
        
        return matchesStatus && matchesBrigade && matchesUrgent;
    });
    
    // Обновление счетчика
    document.getElementById('mapTaskCount').textContent = `${filteredTasks.length} объектов`;
    
    // Добавление маркеров для отфильтрованных задач
    filteredTasks.forEach(task => {
        addTaskMarker(task);
    });
    
    // Обновление статистики
    updateMapStatistics(filteredTasks);
}

function addTaskMarker(task) {
    // Генерация случайных координат для демонстрации
    // В реальном приложении координаты должны получаться через геокодирование адреса
    const lat = 55.7558 + (Math.random() - 0.5) * 0.2;
    const lng = 37.6176 + (Math.random() - 0.5) * 0.3;
    
    // Определение цвета маркера по статусу
    const markerColor = getMarkerColor(task.status);
    
    // Создание HTML для маркера
    const markerHtml = createMarkerHtml(markerColor, task.urgent);
    
    // Создание кастомного маркера
    const marker = L.marker([lat, lng], {
        icon: L.divIcon({
            html: markerHtml,
            className: 'custom-marker',
            iconSize: [20, 20],
            iconAnchor: [10, 10]
        })
    }).addTo(map);
    
    // Добавление popup с информацией о задаче
    const popupContent = createPopupContent(task);
    marker.bindPopup(popupContent);
    
    // Обработчик клика на маркер
    marker.on('click', function() {
        showTaskInfo(task);
        selectedTaskId = task.id;
    });
    
    markers.push(marker);
}

function getMarkerColor(status) {
    switch(status) {
        case 'Новая задача': return '#0dcaf0'; // info
        case 'В работе': return '#ffc107'; // warning
        case 'Выполнено': return '#198754'; // success
        case 'Отложено': return '#6c757d'; // secondary
        case 'Проблемный дом': return '#dc3545'; // danger
        default: return '#0dcaf0';
    }
}

function createMarkerHtml(color, isUrgent) {
    const urgentClass = isUrgent ? 'urgent-marker' : '';
    return `
        <div class="map-marker ${urgentClass}" style="background-color: ${color};">
            <div class="marker-pulse"></div>
        </div>
    `;
}

function createPopupContent(task) {
    const urgentBadge = task.urgent ? '<span class="urgent-badge ms-1">СРОЧНО!</span>' : '';
    const statusClass = getStatusClass(task.status);
    
    return `
        <div class="task-popup">
            <h6 class="mb-2">#${task.id} • ${task.address}${urgentBadge}</h6>
            <div class="mb-2">
                <span class="status-badge ${statusClass}">${task.status}</span>
            </div>
            <div class="small mb-2">
                <strong>Вид работ:</strong> ${task.work_type}<br>
                <strong>Бригада:</strong> ${task.assigned_brigade || 'Не назначена'}
            </div>
            <button class="btn btn-primary btn-sm" onclick="showTaskDetails(${task.id})">
                Подробнее
            </button>
        </div>
    `;
}

function getStatusClass(status) {
    switch(status) {
        case 'Новая задача': return 'status-new';
        case 'В работе': return 'status-progress';
        case 'Выполнено': return 'status-completed';
        case 'Отложено': return 'status-postponed';
        case 'Проблемный дом': return 'status-problem';
        default: return 'status-new';
    }
}

function showTaskInfo(task) {
    const container = document.getElementById('mapTaskInfo');
    const urgentBadge = task.urgent ? '<span class="urgent-badge ms-1">СРОЧНО!</span>' : '';
    const statusClass = getStatusClass(task.status);
    const createdDate = task.created_date ? new Date(task.created_date).toLocaleDateString() : '-';
    
    container.innerHTML = `
        <div class="selected-task">
            <h6 class="text-primary mb-3">#${task.id} • ${task.address}${urgentBadge}</h6>
            
            <div class="mb-3">
                <span class="status-badge ${statusClass}">${task.status}</span>
            </div>
            
            <div class="info-row mb-2">
                <strong>Вид работ:</strong><br>
                <span class="text-muted">${task.work_type}</span>
            </div>
            
            <div class="info-row mb-2">
                <strong>Этажи/Парадные:</strong><br>
                <span class="text-muted">${task.floors}/${task.entrances}</span>
            </div>
            
            <div class="info-row mb-2">
                <strong>Бригада:</strong><br>
                <span class="text-muted">${task.assigned_brigade || 'Не назначена'}</span>
            </div>
            
            <div class="info-row mb-2">
                <strong>Дата создания:</strong><br>
                <span class="text-muted">${createdDate}</span>
            </div>
            
            <div class="info-row mb-3">
                <strong>Описание:</strong><br>
                <span class="text-muted small">${task.description ? task.description.substring(0, 100) + '...' : 'Нет описания'}</span>
            </div>
            
            <div class="d-grid gap-2">
                <button class="btn btn-primary btn-sm" onclick="showTaskDetails(${task.id})">
                    <i class="bi bi-eye me-1"></i>Подробнее
                </button>
                ${getTaskActionButtons(task)}
            </div>
        </div>
    `;
}

function getTaskActionButtons(task) {
    const userRole = '{{ user.role }}';
    const userName = '{{ user.name }}';
    let buttons = '';
    
    if (userRole === 'brigade' && task.assigned_brigade === userName && task.status === 'В работе') {
        buttons += `
            <button class="btn btn-success btn-sm" onclick="location.href='/task/${task.id}/report'">
                <i class="bi bi-file-earmark-text me-1"></i>Создать отчет
            </button>
        `;
    }
    
    if (userRole === 'super_admin' || userRole === 'admin') {
        buttons += `
            <button class="btn btn-outline-primary btn-sm" onclick="editTask(${task.id})">
                <i class="bi bi-pencil me-1"></i>Редактировать
            </button>
        `;
    }
    
    return buttons;
}

function showTaskDetails(taskId) {
    const task = allTasks.find(t => t.id === taskId);
    if (!task) return;
    
    const modal = new bootstrap.Modal(document.getElementById('mapTaskModal'));
    const content = document.getElementById('mapTaskModalContent');
    
    const urgentBadge = task.urgent ? '<span class="urgent-badge ms-1">СРОЧНО!</span>' : '';
    const statusClass = getStatusClass(task.status);
    const createdDate = task.created_date ? new Date(task.created_date).toLocaleDateString() : '-';
    
    content.innerHTML = `
        <div class="row">
            <div class="col-md-6">
                <h6 class="text-primary">Основная информация</h6>
                <table class="table table-sm">
                    <tr><td><strong>ID:</strong></td><td>#${task.id}</td></tr>
                    <tr><td><strong>Адрес:</strong></td><td>${task.address}${urgentBadge}</td></tr>
                    <tr><td><strong>Этажи:</strong></td><td>${task.floors}</td></tr>
                    <tr><td><strong>Парадные:</strong></td><td>${task.entrances}</td></tr>
                    <tr><td><strong>Вид работ:</strong></td><td>${task.work_type}</td></tr>
                    <tr><td><strong>Статус:</strong></td><td><span class="status-badge ${statusClass}">${task.status}</span></td></tr>
                </table>
            </div>
            <div class="col-md-6">
                <h6 class="text-primary">Назначение</h6>
                <table class="table table-sm">
                    <tr><td><strong>Создатель:</strong></td><td>${task.created_by || '-'}</td></tr>
                    <tr><td><strong>Бригада:</strong></td><td>${task.assigned_brigade || '-'}</td></tr>
                    <tr><td><strong>Дата создания:</strong></td><td>${createdDate}</td></tr>
                </table>
            </div>
        </div>
        <div class="row mt-3">
            <div class="col-12">
                <h6 class="text-primary">Описание</h6>
                <div class="border rounded p-3 bg-light">
                    ${task.description || 'Нет описания'}
                </div>
            </div>
        </div>
    `;
    
    selectedTaskId = taskId;
    modal.show();
}

function updateMapStatistics(filteredTasks = null) {
    const tasks = filteredTasks || allTasks;
    const stats = {
        new: tasks.filter(t => t.status === 'Новая задача').length,
        progress: tasks.filter(t => t.status === 'В работе').length,
        completed: tasks.filter(t => t.status === 'Выполнено').length,
        postponed: tasks.filter(t => t.status === 'Отложено').length,
        problem: tasks.filter(t => t.status === 'Проблемный дом').length,
        urgent: tasks.filter(t => t.urgent).length
    };
    
    const container = document.getElementById('mapStatistics');
    container.innerHTML = `
        <div class="stat-item d-flex justify-content-between mb-2">
            <span class="d-flex align-items-center">
                <div class="stat-color bg-info me-2"></div>
                Новые
            </span>
            <span class="fw-bold">${stats.new}</span>
        </div>
        <div class="stat-item d-flex justify-content-between mb-2">
            <span class="d-flex align-items-center">
                <div class="stat-color bg-warning me-2"></div>
                В работе
            </span>
            <span class="fw-bold">${stats.progress}</span>
        </div>
        <div class="stat-item d-flex justify-content-between mb-2">
            <span class="d-flex align-items-center">
                <div class="stat-color bg-success me-2"></div>
                Выполнено
            </span>
            <span class="fw-bold">${stats.completed}</span>
        </div>
        <div class="stat-item d-flex justify-content-between mb-2">
            <span class="d-flex align-items-center">
                <div class="stat-color bg-secondary me-2"></div>
                Отложено
            </span>
            <span class="fw-bold">${stats.postponed}</span>
        </div>
        <div class="stat-item d-flex justify-content-between mb-2">
            <span class="d-flex align-items-center">
                <div class="stat-color bg-danger me-2"></div>
                Проблемные
            </span>
            <span class="fw-bold">${stats.problem}</span>
        </div>
        <hr>
        <div class="stat-item d-flex justify-content-between">
            <span class="text-danger fw-bold">Срочные</span>
            <span class="fw-bold text-danger">${stats.urgent}</span>
        </div>
    `;
}

function centerMap() {
    if (markers.length > 0) {
        const group = new L.featureGroup(markers);
        map.fitBounds(group.getBounds().pad(0.1));
    } else {
        map.setView([55.7558, 37.6176], 10);
    }
}

function toggleFullscreen() {
    const mapContainer = document.getElementById('map');
    if (!document.fullscreenElement) {
        mapContainer.requestFullscreen().then(() => {
            setTimeout(() => map.invalidateSize(), 100);
        });
    } else {
        document.exitFullscreen().then(() => {
            setTimeout(() => map.invalidateSize(), 100);
        });
    }
}

function viewFullTaskDetails() {
    if (selectedTaskId) {
        location.href = `/task/${selectedTaskId}`;
    }
}

function editTask(taskId) {
    location.href = `/task/${taskId}/edit`;
}

// Обновление данных каждые 30 секунд
setInterval(loadMapTasks, 30000);
</script>

<style>
.custom-marker {
    border: none !important;
    background: none !important;
}

.map-marker {
    width: 20px;
    height: 20px;
    border-radius: 50%;
    border: 2px solid white;
    box-shadow: 0 2px 6px rgba(0,0,0,0.3);
    position: relative;
    animation: pulse 2s infinite;
}

.urgent-marker {
    border-color: #dc3545 !important;
    border-width: 3px !important;
    animation: urgentPulse 1s infinite;
}

@keyframes pulse {
    0% { transform: scale(1); }
    50% { transform: scale(1.1); }
    100% { transform: scale(1); }
}

@keyframes urgentPulse {
    0% { transform: scale(1); box-shadow: 0 2px 6px rgba(0,0,0,0.3), 0 0 0 0 rgba(220, 53, 69, 0.7); }
    70% { transform: scale(1.1); box-shadow: 0 2px 6px rgba(0,0,0,0.3), 0 0 0 10px rgba(220, 53, 69, 0); }
    100% { transform: scale(1); box-shadow: 0 2px 6px rgba(0,0,0,0.3), 0 0 0 0 rgba(220, 53, 69, 0); }
}

.task-popup {
    min-width: 250px;
}

.selected-task {
    border-left: 4px solid var(--primary-color);
    padding-left: 15px;
}

.info-row {
    padding: 8px 0;
    border-bottom: 1px solid #f0f0f0;
}

.info-row:last-child {
    border-bottom: none;
}

.stat-color {
    width: 12px;
    height: 12px;
    border-radius: 50%;
}

.leaflet-popup-content-wrapper {
    border-radius: 10px;
}

.leaflet-popup-tip {
    background: white;
}
</style>
{% endblock %}