{% extends "base.html" %}

{% block title %}Отчеты - AWR{% endblock %}

{% block page_title %}
<i class="bi bi-file-earmark-text me-2"></i>Отчеты
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Фильтры -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card-modern">
                <div class="card-header bg-gradient-info text-white">
                    <h6 class="mb-0">
                        <i class="bi bi-funnel me-2"></i>Фильтры отчетов
                    </h6>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-3">
                            <label class="form-label">Период</label>
                            <select class="form-select" id="periodFilter" onchange="applyFilters()">
                                <option value="all">Весь период</option>
                                <option value="today">Сегодня</option>
                                <option value="week">Эта неделя</option>
                                <option value="month">Этот месяц</option>
                                <option value="custom">Свой период</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Статус</label>
                            <select class="form-select" id="statusFilter" onchange="applyFilters()">
                                <option value="">Все статусы</option>
                                <option value="Выполнено">Выполнено</option>
                                <option value="В работе">В работе</option>
                                <option value="Отложено">Отложено</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Бригада</label>
                            <select class="form-select" id="brigadeFilter" onchange="applyFilters()">
                                <option value="">Все бригады</option>
                                <option value="Бригада 1">Бригада 1</option>
                                <option value="Бригада 2">Бригада 2</option>
                                <option value="Бригада 3">Бригада 3</option>
                                <option value="Бригада 4">Бригада 4</option>
                                <option value="Бригада 5">Бригада 5</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Поиск по адресу</label>
                            <input type="text" class="form-control" id="addressSearch" 
                                   placeholder="Введите адрес" onkeyup="applyFilters()">
                        </div>
                    </div>
                    <div class="row mt-3" id="customPeriodRow" style="display: none;">
                        <div class="col-md-3">
                            <label class="form-label">Дата с</label>
                            <input type="date" class="form-control" id="dateFrom" onchange="applyFilters()">
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Дата по</label>
                            <input type="date" class="form-control" id="dateTo" onchange="applyFilters()">
                        </div>
                        <div class="col-md-6 d-flex align-items-end">
                            <button class="btn btn-outline-success" onclick="exportReports()">
                                <i class="bi bi-download me-2"></i>Экспорт в Excel
                            </button>
                            <span class="badge bg-primary ms-3" id="reportCount">0 отчетов</span>
                        </div>
                    </div>
                    <div class="row mt-3" id="regularActionsRow">
                        <div class="col-12 d-flex justify-content-between align-items-center">
                            <div>
                                <button class="btn btn-outline-primary" onclick="clearFilters()">
                                    <i class="bi bi-x-circle me-2"></i>Очистить фильтры
                                </button>
                            </div>
                            <div>
                                <button class="btn btn-outline-success" onclick="exportReports()">
                                    <i class="bi bi-download me-2"></i>Экспорт в Excel
                                </button>
                                <span class="badge bg-primary ms-3" id="reportCount">0 отчетов</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Список отчетов -->
    <div class="row" id="reportsContainer">
        <!-- Отчеты будут загружены динамически -->
    </div>

    <!-- Пагинация -->
    <div class="row mt-4">
        <div class="col-12">
            <nav aria-label="Навигация по страницам">
                <ul class="pagination justify-content-center" id="reportsPagination">
                    <!-- Пагинация будет создана динамически -->
                </ul>
            </nav>
        </div>
    </div>
</div>

<!-- Модальное окно для просмотра отчета -->
<div class="modal fade" id="reportDetailModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Детали отчета</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="reportDetailContent">
                <!-- Содержимое отчета будет загружено динамически -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Закрыть</button>
                <button type="button" class="btn btn-primary" id="downloadReportBtn">
                    <i class="bi bi-download me-2"></i>Скачать отчет
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let allReports = [];
let filteredReports = [];
let currentPage = 1;
const reportsPerPage = 9;

// Загрузка отчетов при загрузке страницы
document.addEventListener('DOMContentLoaded', function() {
    loadReports();
    
    // Обработчик изменения периода
    document.getElementById('periodFilter').addEventListener('change', function() {
        const customRow = document.getElementById('customPeriodRow');
        const regularRow = document.getElementById('regularActionsRow');
        
        if (this.value === 'custom') {
            customRow.style.display = 'flex';
            regularRow.style.display = 'none';
        } else {
            customRow.style.display = 'none';
            regularRow.style.display = 'flex';
        }
    });
});

function loadReports() {
    // Симуляция загрузки отчетов
    // В реальном приложении это будет API вызов
    allReports = generateMockReports();
    applyFilters();
}

function generateMockReports() {
    const reports = [];
    const brigades = ['Бригада 1', 'Бригада 2', 'Бригада 3', 'Бригада 4', 'Бригада 5'];
    const addresses = [
        'ул. Ленина, д. 15',
        'пр. Мира, д. 8',
        'ул. Победы, д. 3',
        'пр. Гагарина, д. 22',
        'ул. Советская, д. 45',
        'пр. Строителей, д. 12',
        'ул. Молодежная, д. 7',
        'пр. Космонавтов, д. 31'
    ];
    const workTypes = ['воздушка', 'перемычка', 'растянуть дом', 'дом под ключ', 'бурение', 'сварки'];
    const statuses = ['Выполнено', 'В работе', 'Отложено'];
    
    for (let i = 1; i <= 25; i++) {
        const date = new Date();
        date.setDate(date.getDate() - Math.floor(Math.random() * 30));
        
        reports.push({
            id: i,
            taskId: 100 + i,
            brigade: brigades[Math.floor(Math.random() * brigades.length)],
            address: addresses[Math.floor(Math.random() * addresses.length)],
            workType: workTypes[Math.floor(Math.random() * workTypes.length)],
            status: statuses[Math.floor(Math.random() * statuses.length)],
            date: date.toISOString(),
            comment: `Отчет по задаче #${100 + i}. Работы выполнены в соответствии с техническим заданием.`,
            access: 'Код домофона: 123К',
            photos: Math.floor(Math.random() * 5) + 1,
            materials: [
                { name: 'Кабель ВОК 4 100', quantity: Math.floor(Math.random() * 100) + 10 },
                { name: 'БО/16 100', quantity: Math.floor(Math.random() * 20) + 5 }
            ]
        });
    }
    
    return reports;
}

function applyFilters() {
    const periodFilter = document.getElementById('periodFilter').value;
    const statusFilter = document.getElementById('statusFilter').value;
    const brigadeFilter = document.getElementById('brigadeFilter').value;
    const addressSearch = document.getElementById('addressSearch').value.toLowerCase();
    
    filteredReports = allReports.filter(report => {
        const matchesPeriod = filterByPeriod(report, periodFilter);
        const matchesStatus = !statusFilter || report.status === statusFilter;
        const matchesBrigade = !brigadeFilter || report.brigade === brigadeFilter;
        const matchesAddress = !addressSearch || report.address.toLowerCase().includes(addressSearch);
        
        return matchesPeriod && matchesStatus && matchesBrigade && matchesAddress;
    });
    
    currentPage = 1;
    displayReports();
    updateReportsPagination();
    updateReportCount();
}

function filterByPeriod(report, period) {
    const reportDate = new Date(report.date);
    const now = new Date();
    
    switch(period) {
        case 'today':
            return reportDate.toDateString() === now.toDateString();
        case 'week':
            const weekStart = new Date(now);
            weekStart.setDate(now.getDate() - now.getDay());
            return reportDate >= weekStart;
        case 'month':
            return reportDate.getMonth() === now.getMonth() && reportDate.getFullYear() === now.getFullYear();
        case 'custom':
            const dateFrom = document.getElementById('dateFrom').value;
            const dateTo = document.getElementById('dateTo').value;
            if (dateFrom && dateTo) {
                return reportDate >= new Date(dateFrom) && reportDate <= new Date(dateTo);
            }
            return true;
        default:
            return true;
    }
}

function displayReports() {
    const startIndex = (currentPage - 1) * reportsPerPage;
    const endIndex = startIndex + reportsPerPage;
    const reportsToShow = filteredReports.slice(startIndex, endIndex);
    
    const container = document.getElementById('reportsContainer');
    
    if (reportsToShow.length === 0) {
        container.innerHTML = `
            <div class="col-12 text-center p-5">
                <i class="bi bi-file-earmark-text display-1 text-muted"></i>
                <h4 class="mt-3 text-muted">Отчеты не найдены</h4>
                <p class="text-muted">Попробуйте изменить параметры фильтра</p>
            </div>
        `;
        return;
    }
    
    let html = '';
    
    reportsToShow.forEach(report => {
        const statusClass = getStatusClass(report.status);
        const reportDate = new Date(report.date).toLocaleDateString();
        const materialsText = report.materials.map(m => `${m.name}: ${m.quantity}`).join(', ');
        
        html += `
            <div class="col-lg-4 col-md-6 mb-4">
                <div class="card-modern h-100" onclick="showReportDetail(${report.id})">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-start mb-3">
                            <h6 class="card-title mb-0">
                                Отчет #${report.id}
                            </h6>
                            <span class="status-badge ${statusClass}">${report.status}</span>
                        </div>
                        
                        <div class="mb-3">
                            <div class="d-flex justify-content-between mb-1">
                                <span class="text-muted small">Задача:</span>
                                <span class="small fw-bold">#${report.taskId}</span>
                            </div>
                            <div class="d-flex justify-content-between mb-1">
                                <span class="text-muted small">Адрес:</span>
                                <span class="small">${report.address}</span>
                            </div>
                            <div class="d-flex justify-content-between mb-1">
                                <span class="text-muted small">Бригада:</span>
                                <span class="small">${report.brigade}</span>
                            </div>
                            <div class="d-flex justify-content-between mb-1">
                                <span class="text-muted small">Дата:</span>
                                <span class="small">${reportDate}</span>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <small class="text-muted">Вид работ:</small>
                            <div class="fw-bold">${report.workType}</div>
                        </div>
                        
                        <div class="mb-3">
                            <small class="text-muted">Комментарий:</small>
                            <div class="text-truncate small">${report.comment}</div>
                        </div>
                        
                        <div class="border-top pt-2">
                            <div class="d-flex justify-content-between text-muted small">
                                <span><i class="bi bi-camera me-1"></i>${report.photos} фото</span>
                                <span><i class="bi bi-box me-1"></i>${report.materials.length} мат.</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `;
    });
    
    container.innerHTML = html;
}

function getStatusClass(status) {
    switch(status) {
        case 'В работе': return 'status-progress';
        case 'Выполнено': return 'status-completed';
        case 'Отложено': return 'status-postponed';
        default: return 'status-new';
    }
}

function showReportDetail(reportId) {
    const report = allReports.find(r => r.id === reportId);
    if (!report) return;
    
    const modal = new bootstrap.Modal(document.getElementById('reportDetailModal'));
    const content = document.getElementById('reportDetailContent');
    
    const statusClass = getStatusClass(report.status);
    const reportDate = new Date(report.date).toLocaleDateString();
    
    let materialsHtml = '';
    report.materials.forEach(material => {
        materialsHtml += `
            <tr>
                <td>${material.name}</td>
                <td>${material.quantity}</td>
            </tr>
        `;
    });
    
    content.innerHTML = `
        <div class="row">
            <div class="col-md-6">
                <h6 class="text-primary mb-3">Основная информация</h6>
                <table class="table table-sm">
                    <tr><td><strong>ID отчета:</strong></td><td>#${report.id}</td></tr>
                    <tr><td><strong>ID задачи:</strong></td><td>#${report.taskId}</td></tr>
                    <tr><td><strong>Бригада:</strong></td><td>${report.brigade}</td></tr>
                    <tr><td><strong>Адрес:</strong></td><td>${report.address}</td></tr>
                    <tr><td><strong>Вид работ:</strong></td><td>${report.workType}</td></tr>
                    <tr><td><strong>Статус:</strong></td><td><span class="status-badge ${statusClass}">${report.status}</span></td></tr>
                    <tr><td><strong>Дата отчета:</strong></td><td>${reportDate}</td></tr>
                </table>
            </div>
            <div class="col-md-6">
                <h6 class="text-primary mb-3">Материалы</h6>
                <table class="table table-sm">
                    <thead>
                        <tr>
                            <th>Материал</th>
                            <th>Количество</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${materialsHtml}
                    </tbody>
                </table>
            </div>
        </div>
        
        <div class="row mt-4">
            <div class="col-md-6">
                <h6 class="text-primary">Комментарий</h6>
                <div class="border rounded p-3 bg-light">
                    ${report.comment}
                </div>
            </div>
            <div class="col-md-6">
                <h6 class="text-primary">Информация о доступе</h6>
                <div class="border rounded p-3 bg-light">
                    ${report.access}
                </div>
            </div>
        </div>
        
        <div class="row mt-4">
            <div class="col-12">
                <h6 class="text-primary">Фотографии (${report.photos})</h6>
                <div class="d-flex flex-wrap gap-2">
                    ${generatePhotoPlaceholders(report.photos)}
                </div>
            </div>
        </div>
    `;
    
    modal.show();
}

function generatePhotoPlaceholders(count) {
    let html = '';
    for (let i = 1; i <= count; i++) {
        html += `
            <div class="border rounded p-3 text-center bg-light" style="width: 120px; height: 90px;">
                <i class="bi bi-image text-muted" style="font-size: 2rem;"></i>
                <div class="small text-muted">Фото ${i}</div>
            </div>
        `;
    }
    return html;
}

function clearFilters() {
    document.getElementById('periodFilter').value = 'all';
    document.getElementById('statusFilter').value = '';
    document.getElementById('brigadeFilter').value = '';
    document.getElementById('addressSearch').value = '';
    document.getElementById('dateFrom').value = '';
    document.getElementById('dateTo').value = '';
    
    // Скрыть кастомный период
    document.getElementById('customPeriodRow').style.display = 'none';
    document.getElementById('regularActionsRow').style.display = 'flex';
    
    applyFilters();
}

function updateReportCount() {
    const count = filteredReports.length;
    const countText = count === 1 ? '1 отчет' : 
                     count < 5 ? `${count} отчета` : 
                     `${count} отчетов`;
    document.getElementById('reportCount').textContent = countText;
}

function updateReportsPagination() {
    const totalPages = Math.ceil(filteredReports.length / reportsPerPage);
    const pagination = document.getElementById('reportsPagination');
    
    if (totalPages <= 1) {
        pagination.innerHTML = '';
        return;
    }
    
    let html = '';
    
    // Предыдущая страница
    html += `
        <li class="page-item ${currentPage === 1 ? 'disabled' : ''}">
            <a class="page-link" href="#" onclick="changeReportsPage(${currentPage - 1})">Предыдущая</a>
        </li>
    `;
    
    // Номера страниц
    for (let i = 1; i <= totalPages; i++) {
        if (i === 1 || i === totalPages || (i >= currentPage - 2 && i <= currentPage + 2)) {
            html += `
                <li class="page-item ${i === currentPage ? 'active' : ''}">
                    <a class="page-link" href="#" onclick="changeReportsPage(${i})">${i}</a>
                </li>
            `;
        } else if (i === currentPage - 3 || i === currentPage + 3) {
            html += '<li class="page-item disabled"><span class="page-link">...</span></li>';
        }
    }
    
    // Следующая страница
    html += `
        <li class="page-item ${currentPage === totalPages ? 'disabled' : ''}">
            <a class="page-link" href="#" onclick="changeReportsPage(${currentPage + 1})">Следующая</a>
        </li>
    `;
    
    pagination.innerHTML = html;
}

function changeReportsPage(page) {
    const totalPages = Math.ceil(filteredReports.length / reportsPerPage);
    if (page < 1 || page > totalPages) return;
    
    currentPage = page;
    displayReports();
    updateReportsPagination();
    
    // Прокрутка к началу списка
    document.querySelector('.container-fluid').scrollIntoView({ behavior: 'smooth' });
}

function exportReports() {
    // Здесь будет реализован экспорт в Excel
    alert(`Экспорт ${filteredReports.length} отчетов в Excel будет реализован`);
}

// Обновление данных каждые 30 секунд
setInterval(loadReports, 30000);
</script>
{% endblock %}