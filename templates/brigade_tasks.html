{% extends "base.html" %}

{% block title %}Мои задачи - AWR{% endblock %}

{% block page_title %}
<i class="bi bi-list-task me-2"></i>Мои задачи
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Статистика -->
    <div class="row mb-4">
        <div class="col-md-4">
            <div class="card-modern">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="text-muted mb-1">Активные задачи</h6>
                            <h3 class="mb-0 text-warning">{{ active_tasks|length }}</h3>
                        </div>
                        <div class="rounded-circle bg-warning bg-gradient p-3">
                            <i class="bi bi-gear text-white fs-4"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card-modern">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="text-muted mb-1">Выполненные</h6>
                            <h3 class="mb-0 text-success">{{ completed_tasks|length }}</h3>
                        </div>
                        <div class="rounded-circle bg-success bg-gradient p-3">
                            <i class="bi bi-check-circle text-white fs-4"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card-modern">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="text-muted mb-1">Отложенные</h6>
                            <h3 class="mb-0 text-info">{{ postponed_tasks|length }}</h3>
                        </div>
                        <div class="rounded-circle bg-info bg-gradient p-3">
                            <i class="bi bi-pause-circle text-white fs-4"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Вкладки -->
    <div class="row">
        <div class="col-12">
            <div class="card-modern">
                <div class="card-header bg-gradient-primary text-white">
                    <ul class="nav nav-tabs card-header-tabs" id="tasksTab" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active text-white" id="active-tab" data-bs-toggle="tab" 
                                    data-bs-target="#active" type="button" role="tab">
                                <i class="bi bi-gear me-2"></i>В работе ({{ active_tasks|length }})
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link text-white-50" id="completed-tab" data-bs-toggle="tab" 
                                    data-bs-target="#completed" type="button" role="tab">
                                <i class="bi bi-check-circle me-2"></i>Выполненные ({{ completed_tasks|length }})
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link text-white-50" id="postponed-tab" data-bs-toggle="tab" 
                                    data-bs-target="#postponed" type="button" role="tab">
                                <i class="bi bi-pause-circle me-2"></i>Отложенные ({{ postponed_tasks|length }})
                            </button>
                        </li>
                    </ul>
                </div>
                <div class="card-body">
                    <div class="tab-content" id="tasksTabContent">
                        <!-- Активные задачи -->
                        <div class="tab-pane fade show active" id="active" role="tabpanel">
                            {% if active_tasks %}
                            <div class="row">
                                {% for task in active_tasks %}
                                <div class="col-lg-6 col-xl-4 mb-4">
                                    <div class="card task-card h-100 border-warning">
                                        <div class="card-body">
                                            <div class="d-flex justify-content-between align-items-start mb-3">
                                                <h6 class="card-title mb-0">
                                                    #{{ task.id }} • {{ task.address }}
                                                    {% if task.urgent %}
                                                    <span class="urgent-badge ms-2">СРОЧНО!</span>
                                                    {% endif %}
                                                </h6>
                                                <span class="status-badge status-progress">{{ task.status }}</span>
                                            </div>
                                            
                                            <div class="mb-3">
                                                <div class="d-flex justify-content-between mb-1">
                                                    <span class="text-muted small">Вид работ:</span>
                                                    <span class="small fw-bold">{{ task.work_type }}</span>
                                                </div>
                                                <div class="d-flex justify-content-between mb-1">
                                                    <span class="text-muted small">Этажи/Парадные:</span>
                                                    <span class="small">{{ task.floors }}/{{ task.entrances }}</span>
                                                </div>
                                                <div class="d-flex justify-content-between mb-1">
                                                    <span class="text-muted small">Назначено:</span>
                                                    <span class="small">
                                                        {% if task.assigned_date %}
                                                        {{ task.assigned_date[:10] }}
                                                        {% else %}
                                                        -
                                                        {% endif %}
                                                    </span>
                                                </div>
                                            </div>
                                            
                                            <div class="mb-3">
                                                <small class="text-muted">Техническое задание:</small>
                                                <div class="text-truncate small" title="{{ task.description }}">
                                                    {{ task.description[:100] }}{% if task.description|length > 100 %}...{% endif %}
                                                </div>
                                            </div>
                                            
                                            {% if task.access_info %}
                                            <div class="mb-3">
                                                <small class="text-muted">Доступ:</small>
                                                <div class="text-truncate small bg-light p-2 rounded" title="{{ task.access_info }}">
                                                    {{ task.access_info[:50] }}{% if task.access_info|length > 50 %}...{% endif %}
                                                </div>
                                            </div>
                                            {% endif %}
                                        </div>
                                        <div class="card-footer bg-light">
                                            <div class="d-flex justify-content-between align-items-center">
                                                <button class="btn btn-outline-info btn-sm" onclick="viewTaskDetail({{ task.id }})">
                                                    <i class="bi bi-eye me-1"></i>Подробнее
                                                </button>
                                                <button class="btn btn-success btn-sm" onclick="location.href='{{ url_for('task_report', task_id=task.id) }}'">
                                                    <i class="bi bi-file-earmark-text me-1"></i>Отчет
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                            {% else %}
                            <div class="text-center p-5">
                                <i class="bi bi-check-circle display-1 text-success"></i>
                                <h4 class="mt-3">Все задачи выполнены!</h4>
                                <p class="text-muted">У вас нет активных задач на данный момент</p>
                            </div>
                            {% endif %}
                        </div>

                        <!-- Выполненные задачи -->
                        <div class="tab-pane fade" id="completed" role="tabpanel">
                            {% if completed_tasks %}
                            <div class="row">
                                {% for task in completed_tasks %}
                                <div class="col-lg-6 col-xl-4 mb-4">
                                    <div class="card task-card h-100 border-success">
                                        <div class="card-body">
                                            <div class="d-flex justify-content-between align-items-start mb-3">
                                                <h6 class="card-title mb-0">
                                                    #{{ task.id }} • {{ task.address }}
                                                </h6>
                                                <span class="status-badge status-completed">{{ task.status }}</span>
                                            </div>
                                            
                                            <div class="mb-3">
                                                <div class="d-flex justify-content-between mb-1">
                                                    <span class="text-muted small">Вид работ:</span>
                                                    <span class="small fw-bold">{{ task.work_type }}</span>
                                                </div>
                                                <div class="d-flex justify-content-between mb-1">
                                                    <span class="text-muted small">Завершено:</span>
                                                    <span class="small">
                                                        {% if task.completed_date %}
                                                        {{ task.completed_date[:10] }}
                                                        {% else %}
                                                        -
                                                        {% endif %}
                                                    </span>
                                                </div>
                                            </div>
                                            
                                            <div class="mb-3">
                                                <small class="text-muted">Результат:</small>
                                                <div class="small bg-success bg-opacity-10 p-2 rounded">
                                                    <i class="bi bi-check-circle-fill text-success me-1"></i>
                                                    Задача успешно выполнена
                                                </div>
                                            </div>
                                        </div>
                                        <div class="card-footer bg-light">
                                            <div class="d-flex justify-content-between align-items-center">
                                                <button class="btn btn-outline-info btn-sm" onclick="viewTaskDetail({{ task.id }})">
                                                    <i class="bi bi-eye me-1"></i>Подробнее
                                                </button>
                                                <button class="btn btn-outline-success btn-sm" onclick="viewReport({{ task.id }})">
                                                    <i class="bi bi-file-earmark-check me-1"></i>Отчет
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                            {% else %}
                            <div class="text-center p-5">
                                <i class="bi bi-clock-history display-1 text-muted"></i>
                                <h4 class="mt-3">Пока нет выполненных задач</h4>
                                <p class="text-muted">Завершенные задачи будут отображаться здесь</p>
                            </div>
                            {% endif %}
                        </div>

                        <!-- Отложенные задачи -->
                        <div class="tab-pane fade" id="postponed" role="tabpanel">
                            {% if postponed_tasks %}
                            <div class="row">
                                {% for task in postponed_tasks %}
                                <div class="col-lg-6 col-xl-4 mb-4">
                                    <div class="card task-card h-100 border-info">
                                        <div class="card-body">
                                            <div class="d-flex justify-content-between align-items-start mb-3">
                                                <h6 class="card-title mb-0">
                                                    #{{ task.id }} • {{ task.address }}
                                                </h6>
                                                <span class="status-badge status-postponed">{{ task.status }}</span>
                                            </div>
                                            
                                            <div class="mb-3">
                                                <div class="d-flex justify-content-between mb-1">
                                                    <span class="text-muted small">Вид работ:</span>
                                                    <span class="small fw-bold">{{ task.work_type }}</span>
                                                </div>
                                                <div class="d-flex justify-content-between mb-1">
                                                    <span class="text-muted small">Отложено:</span>
                                                    <span class="small">
                                                        {% if task.postponed_date %}
                                                        {{ task.postponed_date[:10] }}
                                                        {% else %}
                                                        -
                                                        {% endif %}
                                                    </span>
                                                </div>
                                            </div>
                                            
                                            <div class="mb-3">
                                                <small class="text-muted">Причина:</small>
                                                <div class="small bg-info bg-opacity-10 p-2 rounded">
                                                    <i class="bi bi-pause-circle-fill text-info me-1"></i>
                                                    {{ task.postpone_reason or 'Причина не указана' }}
                                                </div>
                                            </div>
                                        </div>
                                        <div class="card-footer bg-light">
                                            <div class="text-center">
                                                <button class="btn btn-outline-info btn-sm" onclick="viewTaskDetail({{ task.id }})">
                                                    <i class="bi bi-eye me-1"></i>Подробнее
                                                </button>
                                                <small class="text-muted d-block mt-2">
                                                    Редактирование недоступно
                                                </small>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                            {% else %}
                            <div class="text-center p-5">
                                <i class="bi bi-pause-circle display-1 text-muted"></i>
                                <h4 class="mt-3">Нет отложенных задач</h4>
                                <p class="text-muted">Отложенные задачи будут отображаться здесь</p>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Модальное окно для деталей задачи -->
<div class="modal fade" id="taskDetailModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Детали задачи</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="taskDetailContent">
                <!-- Содержимое будет загружено динамически -->
            </div>
            <div class="modal-footer" id="taskDetailActions">
                <!-- Действия будут добавлены динамически -->
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Объединение всех задач для поиска
const allTasks = [
    ...{{ active_tasks | tojsonfilter | safe }},
    ...{{ completed_tasks | tojsonfilter | safe }},
    ...{{ postponed_tasks | tojsonfilter | safe }}
];

function viewTaskDetail(taskId) {
    const task = allTasks.find(t => t.id === taskId);
    if (!task) return;
    
    const modal = new bootstrap.Modal(document.getElementById('taskDetailModal'));
    const content = document.getElementById('taskDetailContent');
    const actions = document.getElementById('taskDetailActions');
    
    const urgentBadge = task.urgent ? '<span class="urgent-badge ms-2">СРОЧНО!</span>' : '';
    const createdDate = task.created_date ? new Date(task.created_date).toLocaleDateString() : '-';
    const assignedDate = task.assigned_date ? new Date(task.assigned_date).toLocaleDateString() : '-';
    const completedDate = task.completed_date ? new Date(task.completed_date).toLocaleDateString() : '-';
    const statusClass = getStatusClass(task.status);
    
    content.innerHTML = `
        <div class="row">
            <div class="col-md-6">
                <h6 class="text-primary">Основная информация</h6>
                <table class="table table-sm">
                    <tr><td><strong>ID:</strong></td><td>#${task.id}</td></tr>
                    <tr><td><strong>Адрес:</strong></td><td>${task.address}${urgentBadge}</td></tr>
                    <tr><td><strong>Этажи:</strong></td><td>${task.floors}</td></tr>
                    <tr><td><strong>Парадные:</strong></td><td>${task.entrances}</td></tr>
                    <tr><td><strong>Вид работ:</strong></td><td>${task.work_type}</td></tr>
                    <tr><td><strong>Статус:</strong></td><td><span class="status-badge ${statusClass}">${task.status}</span></td></tr>
                </table>
            </div>
            <div class="col-md-6">
                <h6 class="text-primary">Временные метки</h6>
                <table class="table table-sm">
                    <tr><td><strong>Создано:</strong></td><td>${createdDate}</td></tr>
                    <tr><td><strong>Назначено:</strong></td><td>${assignedDate}</td></tr>
                    <tr><td><strong>Завершено:</strong></td><td>${completedDate}</td></tr>
                    <tr><td><strong>Создатель:</strong></td><td>${task.created_by || '-'}</td></tr>
                    <tr><td><strong>Бригада:</strong></td><td>{{ user.name }}</td></tr>
                </table>
            </div>
        </div>
        <div class="row mt-3">
            <div class="col-12">
                <h6 class="text-primary">Техническое задание</h6>
                <div class="border rounded p-3 bg-light">
                    ${task.description || 'Нет описания'}
                </div>
            </div>
        </div>
        ${task.access_info ? `
        <div class="row mt-3">
            <div class="col-12">
                <h6 class="text-primary">Информация о доступе</h6>
                <div class="border rounded p-3 bg-light">
                    ${task.access_info}
                </div>
            </div>
        </div>
        ` : ''}
    `;
    
    // Формирование кнопок действий
    let actionsHtml = '<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Закрыть</button>';
    
    if (task.status === 'В работе') {
        actionsHtml += `<button type="button" class="btn btn-success ms-2" onclick="location.href='{{ url_for('task_report', task_id=0) }}'.replace('0', '${task.id}')">Создать отчет</button>`;
    } else if (task.status === 'Выполнено') {
        actionsHtml += `<button type="button" class="btn btn-outline-success ms-2" onclick="viewReport(${task.id})">Просмотреть отчет</button>`;
    }
    
    actions.innerHTML = actionsHtml;
    modal.show();
}

function getStatusClass(status) {
    switch(status) {
        case 'Новая задача': return 'status-new';
        case 'В работе': return 'status-progress';
        case 'Выполнено': return 'status-completed';
        case 'Отложено': return 'status-postponed';
        case 'Проблемный дом': return 'status-problem';
        default: return 'status-new';
    }
}

function viewReport(taskId) {
    // Просмотр отчета по задаче
    alert(`Просмотр отчета по задаче #${taskId} будет реализован`);
}

// Обновление активных вкладок
document.addEventListener('DOMContentLoaded', function() {
    const tabTriggerList = [].slice.call(document.querySelectorAll('#tasksTab button'));
    tabTriggerList.forEach(function (tabTrigger) {
        tabTrigger.addEventListener('shown.bs.tab', function (event) {
            // Обновить стили активной вкладки
            tabTriggerList.forEach(tab => {
                tab.classList.remove('text-white');
                tab.classList.add('text-white-50');
            });
            event.target.classList.remove('text-white-50');
            event.target.classList.add('text-white');
        });
    });
    
    // Автоматическое обновление каждые 30 секунд
    setInterval(() => {
        // В реальном приложении здесь будет обновление данных
        console.log('Обновление данных задач...');
    }, 30000);
});

// Анимация карточек при наведении
document.querySelectorAll('.task-card').forEach(card => {
    card.addEventListener('mouseenter', function() {
        this.style.transform = 'translateY(-5px)';
        this.style.boxShadow = '0 15px 35px rgba(0,0,0,0.1)';
    });
    
    card.addEventListener('mouseleave', function() {
        this.style.transform = 'translateY(0)';
        this.style.boxShadow = '0 10px 30px rgba(0,0,0,0.1)';
    });
});

// Клавиатурные сокращения
document.addEventListener('keydown', function(e) {
    if (e.ctrlKey || e.metaKey) {
        switch(e.key) {
            case '1':
                e.preventDefault();
                document.getElementById('active-tab').click();
                break;
            case '2':
                e.preventDefault();
                document.getElementById('completed-tab').click();
                break;
            case '3':
                e.preventDefault();
                document.getElementById('postponed-tab').click();
                break;
        }
    }
});
</script>

<style>
.task-card {
    transition: all 0.3s ease;
    cursor: pointer;
}

.task-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 15px 35px rgba(0,0,0,0.1);
}

.nav-tabs .nav-link {
    border: none;
    transition: all 0.3s ease;
}

.nav-tabs .nav-link:hover {
    background: rgba(255,255,255,0.1);
}

.nav-tabs .nav-link.active {
    background: rgba(255,255,255,0.2);
    border-color: transparent;
}

.border-warning {
    border-left: 4px solid #ffc107 !important;
}

.border-success {
    border-left: 4px solid #198754 !important;
}

.border-info {
    border-left: 4px solid #0dcaf0 !important;
}

.bg-success.bg-opacity-10 {
    background-color: rgba(25, 135, 84, 0.1) !important;
}

.bg-info.bg-opacity-10 {
    background-color: rgba(13, 202, 240, 0.1) !important;
}

.urgent-badge {
    background: linear-gradient(45deg, #ff6b6b, #ee5a24);
    color: white;
    padding: 4px 8px;
    border-radius: 15px;
    font-size: 10px;
    font-weight: 700;
    animation: pulse 1.5s infinite;
}

@keyframes pulse {
    0% { transform: scale(1); }
    50% { transform: scale(1.05); }
    100% { transform: scale(1); }
}

.text-truncate {
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}
</style>
{% endblock %}